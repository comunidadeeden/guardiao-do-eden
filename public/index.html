<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guardião do Éden</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg-primary: #0D3B3E;
      --bg-secondary: #1A2A2D;
      --bg-tertiary: #0A2E30;
      --text-primary: #FFFFFF;
      --text-secondary: #B0C4C4;
      --text-muted: #7A9A9A;
      --accent-gold: #C8A96E;
      --accent-gold-hover: #D4B87E;
      --accent-gold-dim: rgba(200, 169, 110, 0.15);
      --user-bubble: #1A5C5F;
      --guardian-bubble: #1A2A2D;
      --guardian-border: rgba(200, 169, 110, 0.3);
      --border-subtle: rgba(176, 196, 196, 0.1);
      --danger: #E74C3C;
      --success: #2ECC71;
      --font-serif: 'Cormorant Garamond', Georgia, serif;
      --font-sans: 'Inter', -apple-system, sans-serif;
      --sidebar-width: 280px;
      --header-height: 64px;
    }
    html, body, #root { height: 100%; width: 100%; overflow: hidden; }
    body { font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(176, 196, 196, 0.2); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(176, 196, 196, 0.35); }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes gentleFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

    .fade-in { animation: fadeIn 0.4s ease-out; }

    /* Login page */
    .login-container {
      height: 100vh; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
      position: relative; overflow: hidden;
    }
    .login-container::before {
      content: ''; position: absolute; inset: 0;
      background: radial-gradient(ellipse at 30% 20%, rgba(200, 169, 110, 0.06) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(26, 92, 95, 0.08) 0%, transparent 50%);
    }
    .login-card {
      position: relative; z-index: 1; width: 420px; max-width: 92vw;
      background: rgba(26, 42, 45, 0.85); backdrop-filter: blur(20px);
      border: 1px solid var(--guardian-border); border-radius: 20px;
      padding: 48px 40px; text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 40px rgba(200, 169, 110, 0.05);
    }
    .login-logo { width: 100px; height: 100px; margin: 0 auto 12px; }
    .login-logo svg { width: 100%; height: 100%; }
    .login-title { font-family: var(--font-serif); font-size: 2.4rem; font-weight: 300; letter-spacing: 0.15em; margin-bottom: 6px; color: var(--text-primary); }
    .login-subtitle { font-size: 0.8rem; color: var(--text-muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 36px; }

    .form-group { margin-bottom: 18px; text-align: left; }
    .form-label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; letter-spacing: 0.05em; text-transform: uppercase; }
    .form-input {
      width: 100%; padding: 14px 16px; background: rgba(13, 59, 62, 0.5);
      border: 1px solid var(--border-subtle); border-radius: 10px;
      color: var(--text-primary); font-family: var(--font-sans); font-size: 0.95rem;
      transition: all 0.3s ease; outline: none;
    }
    .form-input:focus { border-color: var(--accent-gold); box-shadow: 0 0 15px rgba(200, 169, 110, 0.1); }
    .form-input::placeholder { color: var(--text-muted); }

    .btn-primary {
      width: 100%; padding: 15px; border: none; border-radius: 10px; cursor: pointer;
      font-family: var(--font-serif); font-size: 1.1rem; font-weight: 500; letter-spacing: 0.08em;
      background: linear-gradient(135deg, var(--accent-gold), #B8964E);
      color: var(--bg-secondary); transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(200, 169, 110, 0.3);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 25px rgba(200, 169, 110, 0.4); background: linear-gradient(135deg, var(--accent-gold-hover), var(--accent-gold)); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }


    .error-msg { color: var(--danger); font-size: 0.82rem; margin-top: 12px; padding: 10px; background: rgba(231, 76, 60, 0.1); border-radius: 8px; border: 1px solid rgba(231, 76, 60, 0.2); }

    /* App layout */
    .app-container { display: flex; height: 100vh; overflow: hidden; }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width); height: 100vh; background: var(--bg-secondary);
      border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column;
      transition: transform 0.3s ease; flex-shrink: 0; z-index: 20;
    }
    .sidebar-header {
      padding: 18px 16px; border-bottom: 1px solid var(--border-subtle);
      display: flex; align-items: center; gap: 12px;
    }
    .sidebar-logo { width: 36px; height: 36px; flex-shrink: 0; }
    .sidebar-logo svg { width: 100%; height: 100%; }
    .sidebar-brand { font-family: var(--font-serif); font-size: 1.15rem; font-weight: 400; letter-spacing: 0.08em; }

    .btn-new-session {
      margin: 14px 14px 8px; padding: 12px; border: 1px dashed var(--guardian-border);
      border-radius: 10px; background: transparent; color: var(--accent-gold);
      font-family: var(--font-sans); font-size: 0.85rem; cursor: pointer;
      transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-new-session:hover { background: var(--accent-gold-dim); border-style: solid; }

    .sidebar-conversations { flex: 1; overflow-y: auto; padding: 8px; }
    .conversation-item {
      padding: 12px 14px; border-radius: 8px; cursor: pointer; margin-bottom: 3px;
      transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between;
      font-size: 0.85rem; color: var(--text-secondary);
    }
    .conversation-item:hover { background: rgba(200, 169, 110, 0.08); color: var(--text-primary); }
    .conversation-item.active { background: var(--accent-gold-dim); color: var(--accent-gold); border: 1px solid rgba(200, 169, 110, 0.15); }
    .conversation-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
    .conversation-date { font-size: 0.7rem; color: var(--text-muted); flex-shrink: 0; margin-left: 8px; }

    .sidebar-footer {
      padding: 14px 16px; border-top: 1px solid var(--border-subtle);
    }
    .sidebar-footer-btn {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px;
      background: transparent; border: none; color: var(--text-secondary);
      font-family: var(--font-sans); font-size: 0.83rem; cursor: pointer; width: 100%; text-align: left;
      transition: all 0.2s;
    }
    .sidebar-footer-btn:hover { background: rgba(176, 196, 196, 0.08); color: var(--text-primary); }
    .sidebar-footer-btn.danger:hover { background: rgba(231, 76, 60, 0.1); color: var(--danger); }

    .delete-btn {
      background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;
      border-radius: 4px; opacity: 0; transition: all 0.2s; flex-shrink: 0; display: flex; align-items: center;
    }
    .conversation-item:hover .delete-btn { opacity: 1; }
    .delete-btn:hover { color: var(--danger); background: rgba(231, 76, 60, 0.1); }

    /* Main chat area */
    .chat-main { flex: 1; display: flex; flex-direction: column; height: 100vh; min-width: 0; }

    .chat-header {
      height: var(--header-height); padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid var(--border-subtle); background: rgba(26, 42, 45, 0.6);
      backdrop-filter: blur(10px); flex-shrink: 0;
    }
    .chat-header-left { display: flex; align-items: center; gap: 12px; }
    .menu-toggle {
      display: none; background: none; border: none; color: var(--text-secondary);
      cursor: pointer; padding: 6px; border-radius: 6px; transition: all 0.2s;
    }
    .menu-toggle:hover { background: rgba(176, 196, 196, 0.1); color: var(--text-primary); }
    .chat-header-title { font-family: var(--font-serif); font-size: 1.25rem; font-weight: 400; letter-spacing: 0.05em; }
    .chat-header-status { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }

    /* Messages area */
    .messages-container { flex: 1; overflow-y: auto; padding: 24px 20px; scroll-behavior: smooth; }
    .messages-inner { max-width: 800px; margin: 0 auto; }

    .message { display: flex; margin-bottom: 20px; animation: fadeIn 0.35s ease-out; }
    .message.user { justify-content: flex-end; }
    .message.guardian { justify-content: flex-start; }

    .message-content {
      max-width: 78%; padding: 16px 20px; border-radius: 16px;
      font-size: 0.92rem; line-height: 1.7; word-wrap: break-word;
    }
    .message.user .message-content {
      background: var(--user-bubble); color: var(--text-primary);
      border-bottom-right-radius: 4px;
    }
    .message.guardian .message-content {
      background: var(--guardian-bubble); color: var(--text-secondary);
      border: 1px solid var(--guardian-border); border-bottom-left-radius: 4px;
      font-family: var(--font-serif); font-size: 1rem; letter-spacing: 0.01em;
    }
    .message.guardian .message-content strong { color: var(--accent-gold); font-weight: 600; }
    .message.guardian .message-content em { color: var(--text-primary); font-style: italic; }

    /* Welcome message */
    .welcome-container {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; padding: 40px 20px; text-align: center;
    }
    .welcome-icon { width: 90px; height: 90px; margin-bottom: 24px; animation: gentleFloat 4s ease-in-out infinite; }
    .welcome-icon svg { width: 100%; height: 100%; }
    .welcome-title { font-family: var(--font-serif); font-size: 1.8rem; font-weight: 300; margin-bottom: 12px; letter-spacing: 0.08em; }
    .welcome-text { font-family: var(--font-serif); color: var(--text-secondary); font-size: 1.05rem; line-height: 1.6; max-width: 480px; }
    .welcome-hint { margin-top: 24px; color: var(--text-muted); font-size: 0.82rem; padding: 10px 18px; background: var(--accent-gold-dim); border-radius: 20px; border: 1px solid rgba(200, 169, 110, 0.15); }
    .welcome-hint code { color: var(--accent-gold); font-family: var(--font-serif); font-weight: 600; font-size: 0.9rem; }

    /* Typing indicator */
    .typing-indicator { display: flex; align-items: center; gap: 5px; padding: 16px 24px; }
    .typing-dot {
      width: 7px; height: 7px; border-radius: 50%; background: var(--accent-gold);
      animation: pulse 1.4s ease-in-out infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    /* Input area */
    .input-container {
      padding: 16px 20px 20px; border-top: 1px solid var(--border-subtle);
      background: rgba(26, 42, 45, 0.4); flex-shrink: 0;
    }
    .input-inner { max-width: 800px; margin: 0 auto; position: relative; }
    .input-wrapper {
      display: flex; align-items: flex-end; gap: 10px;
      background: rgba(13, 59, 62, 0.4); border: 1px solid var(--border-subtle);
      border-radius: 14px; padding: 6px 6px 6px 18px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .input-wrapper:focus-within { border-color: var(--accent-gold); box-shadow: 0 0 20px rgba(200, 169, 110, 0.08); }

    .chat-input {
      flex: 1; background: transparent; border: none; color: var(--text-primary);
      font-family: var(--font-sans); font-size: 0.93rem; padding: 10px 0;
      resize: none; outline: none; max-height: 120px; line-height: 1.5;
    }
    .chat-input::placeholder { color: var(--text-muted); }

    .btn-send {
      width: 42px; height: 42px; border-radius: 10px; border: none; cursor: pointer;
      background: linear-gradient(135deg, var(--accent-gold), #B8964E);
      color: var(--bg-secondary); display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .btn-send:hover { transform: scale(1.05); box-shadow: 0 2px 12px rgba(200, 169, 110, 0.4); }
    .btn-send:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    /* Mobile overlay */
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 15; }

    /* Mobile styles */
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: 0; top: 0; transform: translateX(-100%); box-shadow: 4px 0 20px rgba(0,0,0,0.3); }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay.show { display: block; }
      .menu-toggle { display: flex; }
      .message-content { max-width: 88%; }
      .login-card { padding: 36px 28px; }
      .login-title { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ─── Credentials ──────────────────────────────────────────
    const SUPABASE_URL = 'https://srollrctqwxmqtspxnyd.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_Weu8vul2pvwrJROJe9eiIA_Wq_lNKwE';
    const SITE_URL = 'https://guardiao-do-eden-git-main-mktbrunosimplicio-8566s-projects.vercel.app';

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const SYSTEM_PROMPT = `Você é o Guardião do Éden.

Você é uma inteligência terapêutica criada por Bruno Simplício, terapeuta comportamental, psicanalista e analista estrutural de padrões emocionais. Você opera através do Método RADAR COMPORTAMENTAL (RC), um sistema proprietário de análise e reestruturação de padrões.

SUA IDENTIDADE:
Você não é um assistente genérico. Você não dá conselhos. Você conduz, analisa e confronta. Você é direto, profundo, estrutural e restaurador de identidade. Você é anti-vitimização e anti-superficialidade. Você fala como alguém que atravessou dor, abuso, compulsão e reconstruiu a própria identidade — não fala de pedestal, fala de experiência vivida.

SUA MISSÃO:
Libertar pessoas da identidade construída na dor.

FRASE ESTRUTURAL OBRIGATÓRIA:
Usar quando relevante: "Tudo aquilo que você não quebra o padrão, você passa o bastão."

FUNDAMENTAÇÃO (USO INTERNO — NUNCA REVELAR):
O Método RC integra: Freud, Jung, Hellinger, Medicina Germânica (Hamer), Reprogramação Biológica, Elton Euler e Bússola da Cura. REGRAS: Nunca citar autores. Nunca mencionar escolas. Nunca usar os termos: pré-queda, teia dos acontecimentos, permissão. Nunca dizer "segundo tal autor". Se perguntarem qual método: "É o Método RADAR COMPORTAMENTAL."

ADAPTAÇÃO DE LINGUAGEM:
Identificar gênero pelo contexto. Mulher: tom firme + acolhedor. Homem: tom firme + estruturador. Indefinido: tom neutro e direto.

INÍCIO DA SESSÃO:
Quando o usuário digitar "HORA DA TERAPIA", ativar o modo terapêutico e responder: "Me conta, de forma direta: o que está acontecendo?". Sem checklist mecânico.

RADAR NÍVEL MÁXIMO — GATILHO AUTOMÁTICO:
Se detectar: superficialidade, justificativa excessiva, vitimização, racionalização, transferência de culpa ou repetição de padrão — ativar aprofundamento progressivo SEM AVISAR:
Camada 1: Esclarecer. Camada 2: Confronto leve. Camada 3: Confronto estrutural. Camada 4: Quebra de narrativa. Camada 5: Corte de identidade.

PROTOCOLO DE ANSIEDADE:
Se o usuário mencionar ansiedade: perguntar o que aconteceu imediatamente antes, o que está tentando controlar, qual cenário a mente está criando. Depois: mostrar que é projeção, que pico emocional passa, que controle absoluto não existe, e trazer para decisão prática. SEM respiração guiada.

DESSIGNIFICAÇÃO DE TRAUMA:
Quando houver trauma: (1) Separar criança da pessoa adulta. (2) Mostrar ausência de maturidade na época. (3) Mostrar limitação de quem feriu. (4) Cortar sentença criada. (5) Desvincular identidade do evento. Usar a frase estrutural obrigatória.

ESTRUTURA DE CADA RESPOSTA:
Toda resposta deve conter: (1) Análise profunda com RC ativo. (2) Confronto necessário. (3) Ajuste interno claro. (4) Movimento externo prático.

DIRECIONAMENTO OBRIGATÓRIO:
A resposta NUNCA termina de forma fechada. Sempre finalizar oferecendo 3 caminhos claros para o usuário escolher. Exemplo:
"Agora você escolhe:
1️⃣ Quer aprofundar mais na raiz disso?
2️⃣ Quer que eu estruture um plano prático imediato para quebrar esse padrão?
3️⃣ Ou quer que eu te entregue uma declaração estrutural para reorganizar sua identidade agora?"

ESSÊNCIA:
Você não é conselheiro. Você é reorganizador estrutural. A pessoa entra reativa — sai responsável. Entra confusa — sai decidida. Entra pequena — sai maior.

RESTRIÇÕES DE SEGURANÇA:
Se o usuário demonstrar risco de suicídio, automutilação ou crise severa: sair do modo terapêutico, acolher com empatia, e orientar a buscar ajuda profissional presencial imediatamente (CVV 188, SAMU 192, ou pronto-socorro mais próximo). Não tentar conduzir sessão em situações de risco real.`;

    // ─── SVG Icons ────────────────────────────────────────────
    const EdenLogo = ({ size = 36 }) => (
      <svg width={size} height={size} viewBox="0 0 100 100" fill="none">
        <circle cx="50" cy="50" r="47" stroke="#C8A96E" strokeWidth="1.5" opacity="0.6"/>
        <circle cx="50" cy="50" r="42" stroke="#B0C4C4" strokeWidth="0.5" opacity="0.3"/>
        <path d="M42 28c-4 2-8 6-10 12s-2 14 2 18c2 2 4 2 6 0s4-6 4-12" stroke="#C8A96E" strokeWidth="1.2" fill="none" strokeLinecap="round"/>
        <path d="M38 34c-2 6-2 14 2 18" stroke="#B0C4C4" strokeWidth="0.8" fill="none" opacity="0.5"/>
        <ellipse cx="58" cy="52" rx="10" ry="12" fill="#C8A96E" opacity="0.15" stroke="#C8A96E" strokeWidth="1.2"/>
        <path d="M58 40c2-4 4-6 6-6" stroke="#C8A96E" strokeWidth="1" fill="none" strokeLinecap="round"/>
        <path d="M55 65c-3 4-4 8-3 10s4 2 6 0c2-1 3-4 3-7" stroke="#B0C4C4" strokeWidth="1" fill="none" strokeLinecap="round"/>
        <path d="M65 65c2 4 2 8 1 10s-3 1-4-1" stroke="#B0C4C4" strokeWidth="0.8" fill="none" opacity="0.6" strokeLinecap="round"/>
        <circle cx="58" cy="52" r="3" fill="#C8A96E" opacity="0.3"/>
      </svg>
    );

    const IconSend = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>);
    const IconMenu = () => (<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>);
    const IconPlus = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>);
    const IconLogout = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>);
    const IconTrash = () => (<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>);
    const IconChat = () => (<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>);

    // ─── Login Page ───────────────────────────────────────────
    function LoginPage({ onLogin }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true); setError('');
        try {
          const { data, error: err } = await sb.auth.signInWithPassword({ email, password });
          if (err) throw err;
          onLogin(data.session.user);
        } catch (err) {
          const msg = err.message || 'Erro ao autenticar.';
          if (msg.includes('Invalid login')) setError('Email ou senha incorretos. Verifique suas credenciais.');
          else if (msg.includes('Email not confirmed')) setError('Sua conta ainda não foi ativada. Entre em contato com o suporte.');
          else setError('Não foi possível acessar. Verifique seu email e senha.');
        }
        setLoading(false);
      };

      return (
        <div className="login-container">
          <div className="login-card fade-in">
            <div className="login-logo"><EdenLogo size={100} /></div>
            <h1 className="login-title">Éden</h1>
            <p className="login-subtitle">Guardião do Éden</p>
            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label className="form-label">Email</label>
                <input className="form-input" type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="seu@email.com" required />
              </div>
              <div className="form-group">
                <label className="form-label">Senha</label>
                <input className="form-input" type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Digite sua senha" required minLength={6} />
              </div>
              <button className="btn-primary" type="submit" disabled={loading}>
                {loading ? 'Aguarde...' : 'Entrar no Éden'}
              </button>
            </form>
            {error && <p className="error-msg">{error}</p>}
            <p style={{ marginTop: 24, color: 'var(--text-muted)', fontSize: '0.78rem', lineHeight: 1.5 }}>
              Acesso exclusivo para membros da comunidade Éden.
            </p>
          </div>
        </div>
      );
    }

    // ─── Chat Page ────────────────────────────────────────────
    function ChatPage({ user, onLogout }) {
      const [conversations, setConversations] = useState([]);
      const [activeConversation, setActiveConversation] = useState(null);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [isTyping, setIsTyping] = useState(false);
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };
      useEffect(scrollToBottom, [messages, isTyping]);

      useEffect(() => {
        if (user) loadConversations();
      }, [user]);

      const loadConversations = async () => {
        try {
          const { data, error } = await sb.from('conversations').select('*').eq('user_id', user.id).order('updated_at', { ascending: false });
          if (!error && data) setConversations(data);
        } catch (e) { console.error('Error loading conversations:', e); }
      };

      const loadMessages = async (convId) => {
        try {
          const { data, error } = await sb.from('messages').select('*').eq('conversation_id', convId).order('created_at', { ascending: true });
          if (!error && data) setMessages(data.map(m => ({ role: m.role, content: m.content })));
        } catch (e) { console.error('Error loading messages:', e); }
      };

      const saveMessage = async (convId, role, content) => {
        try {
          await sb.from('messages').insert({ conversation_id: convId, role, content, user_id: user.id });
          if (role === 'user' && messages.length === 0) {
            const title = content.substring(0, 60) + (content.length > 60 ? '...' : '');
            await sb.from('conversations').update({ title, updated_at: new Date().toISOString() }).eq('id', convId);
          } else {
            await sb.from('conversations').update({ updated_at: new Date().toISOString() }).eq('id', convId);
          }
          loadConversations();
        } catch (e) { console.error('Error saving message:', e); }
      };

      const createNewConversation = async () => {
        try {
          const { data, error } = await sb.from('conversations').insert({ user_id: user.id, title: 'Nova Sessão', created_at: new Date().toISOString(), updated_at: new Date().toISOString() }).select().single();
          if (!error && data) {
            await loadConversations();
            return data;
          }
        } catch (e) { console.error('Error creating conversation:', e); }
        return null;
      };

      const handleNewSession = async () => {
        const conv = await createNewConversation();
        if (conv) {
          setActiveConversation(conv);
          setMessages([]);
          setSidebarOpen(false);
          inputRef.current?.focus();
        }
      };

      const handleSelectConversation = async (conv) => {
        setActiveConversation(conv);
        await loadMessages(conv.id);
        setSidebarOpen(false);
      };

      const handleDeleteConversation = async (e, convId) => {
        e.stopPropagation();
        try {
          await sb.from('messages').delete().eq('conversation_id', convId);
          await sb.from('conversations').delete().eq('id', convId);
          if (activeConversation?.id === convId) {
            setActiveConversation(null);
            setMessages([]);
          }
          loadConversations();
        } catch (e) { console.error('Error deleting:', e); }
      };

      const callAI = async (msgs) => {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: 'claude-sonnet-4-5-20250929', max_tokens: 2048, system: SYSTEM_PROMPT, messages: msgs })
        });
        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(errData.error || 'Erro na API. Tente novamente.');
        }
        const data = await res.json();
        return data.content?.[0]?.text || '';
      };

      const handleSend = async () => {
        if (!input.trim() || isTyping) return;
        const userMessage = input.trim();
        setInput('');

        let conv = activeConversation;
        if (!conv) {
          conv = await createNewConversation();
          if (!conv) return;
          setActiveConversation(conv);
        }

        const newMessages = [...messages, { role: 'user', content: userMessage }];
        setMessages(newMessages);
        await saveMessage(conv.id, 'user', userMessage);

        setIsTyping(true);
        try {
          const response = await callAI(newMessages);
          const finalMessages = [...newMessages, { role: 'assistant', content: response }];
          setMessages(finalMessages);
          await saveMessage(conv.id, 'assistant', response);
        } catch (err) {
          setMessages([...newMessages, { role: 'assistant', content: 'Desculpe, houve um erro ao processar sua mensagem. Tente novamente.' }]);
        }
        setIsTyping(false);
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      };

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const now = new Date();
        const diffDays = Math.floor((now - d) / 86400000);
        if (diffDays === 0) return 'Hoje';
        if (diffDays === 1) return 'Ontem';
        if (diffDays < 7) return d.toLocaleDateString('pt-BR', { weekday: 'short' });
        return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
      };

      const formatMessage = (text) => {
        if (!text) return '';
        let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
        formatted = formatted.replace(/\n/g, '<br/>');
        return formatted;
      };

      return (
        <div className="app-container">
          <div className={`sidebar-overlay ${sidebarOpen ? 'show' : ''}`} onClick={() => setSidebarOpen(false)} />

          <aside className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
            <div className="sidebar-header">
              <div className="sidebar-logo"><EdenLogo size={36} /></div>
              <span className="sidebar-brand">Éden</span>
            </div>

            <button className="btn-new-session" onClick={handleNewSession}>
              <IconPlus /> Nova Sessão
            </button>

            <div className="sidebar-conversations">
              {conversations.map(conv => (
                <div key={conv.id} className={`conversation-item ${activeConversation?.id === conv.id ? 'active' : ''}`} onClick={() => handleSelectConversation(conv)}>
                  <IconChat />
                  <span className="conversation-title" style={{ marginLeft: 10 }}>{conv.title || 'Nova Sessão'}</span>
                  <span className="conversation-date">{formatDate(conv.updated_at)}</span>
                  <button className="delete-btn" onClick={(e) => handleDeleteConversation(e, conv.id)} title="Excluir">
                    <IconTrash />
                  </button>
                </div>
              ))}
              {conversations.length === 0 && (
                <p style={{ textAlign: 'center', color: 'var(--text-muted)', fontSize: '0.82rem', padding: '30px 10px', lineHeight: 1.6 }}>
                  Nenhuma sessão ainda.<br/>Clique em "Nova Sessão" para começar.
                </p>
              )}
            </div>

            <div className="sidebar-footer">
              <button className="sidebar-footer-btn danger" onClick={onLogout}>
                <IconLogout /> Sair
              </button>
            </div>
          </aside>

          <main className="chat-main">
            <header className="chat-header">
              <div className="chat-header-left">
                <button className="menu-toggle" onClick={() => setSidebarOpen(!sidebarOpen)}><IconMenu /></button>
                <div>
                  <div className="chat-header-title">Guardião do Éden</div>
                  <div className="chat-header-status">{isTyping ? 'Analisando...' : 'Método RADAR Comportamental'}</div>
                </div>
              </div>
            </header>

            <div className="messages-container">
              <div className="messages-inner">
                {!activeConversation || messages.length === 0 ? (
                  <div className="welcome-container">
                    <div className="welcome-icon"><EdenLogo size={90} /></div>
                    <h2 className="welcome-title">Eu sou o Guardião do Éden</h2>
                    <p className="welcome-text">
                      Um espaço seguro para reorganização estrutural. Aqui você não recebe conselhos — você recebe confronto, análise e direção.
                    </p>
                    <div className="welcome-hint">
                      Quando estiver pronto, digite: <code>HORA DA TERAPIA</code>
                    </div>
                  </div>
                ) : (
                  messages.map((msg, i) => (
                    <div key={i} className={`message ${msg.role === 'user' ? 'user' : 'guardian'}`}>
                      <div className="message-content" dangerouslySetInnerHTML={{ __html: formatMessage(msg.content) }} />
                    </div>
                  ))
                )}
                {isTyping && (
                  <div className="message guardian">
                    <div className="message-content" style={{ padding: '12px 20px' }}>
                      <div className="typing-indicator">
                        <div className="typing-dot" />
                        <div className="typing-dot" />
                        <div className="typing-dot" />
                      </div>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>
            </div>

            <div className="input-container">
              <div className="input-inner">
                <div className="input-wrapper">
                  <textarea
                    ref={inputRef}
                    className="chat-input"
                    value={input}
                    onChange={e => setInput(e.target.value)}
                    onKeyDown={handleKeyDown}
                    placeholder={activeConversation ? "Digite sua mensagem..." : "Inicie uma nova sessão para conversar..."}
                    rows={1}
                    disabled={isTyping}
                    onInput={e => { e.target.style.height = 'auto'; e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px'; }}
                  />
                  <button className="btn-send" onClick={handleSend} disabled={!input.trim() || isTyping}>
                    <IconSend />
                  </button>
                </div>
              </div>
            </div>
          </main>
        </div>
      );
    }

    // ─── App ──────────────────────────────────────────────────
    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        sb.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user || null);
          setLoading(false);
        });

        const { data: { subscription } } = sb.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user || null);
        });

        return () => subscription?.unsubscribe();
      }, []);

      const handleLogout = async () => {
        await sb.auth.signOut();
        setUser(null);
      };

      if (loading) {
        return (
          <div className="login-container">
            <div style={{ textAlign: 'center' }}>
              <EdenLogo size={80} />
              <p style={{ marginTop: 20, color: 'var(--text-muted)', fontFamily: 'var(--font-serif)', fontSize: '1.1rem', letterSpacing: '0.1em' }}>Carregando...</p>
            </div>
          </div>
        );
      }

      if (!user) return <LoginPage onLogin={setUser} />;
      return <ChatPage user={user} onLogout={handleLogout} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
